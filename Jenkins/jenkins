def branchName               =  "main"
def gitUrl                   =  "git@github.com:MomenRahahleh/momen30.git"
def serviceName              =  "mo-todo-list"
def EnvName                  =  "dev"
def imageTag                 =  "${EnvName}_${BUILD_NUMBER}"
def awsRegion                =  "us-east-2"
def ecrUrl                   =  "727245885999.dkr.ecr.us-east-2.amazonaws.com"
def helmDir                  = "slashtec/momen/helm/charts/slashtec-helm-chart"


node () {
    cleanWs()
    try {
        notifyBuild('STARTED')
        
        script {
            properties([
                parameters([
                    string(defaultValue: 'main', name: 'branchName')
                ])
            ])
        }

stage ("Get the app code")
    {
      checkout([$class: 'GitSCM', branches: [[name: "${branchName}"]] , extensions: [], userRemoteConfigs: [[ url: "${gitUrl}"]]])    
        sh "rm -rf ~/workspace/\"${JOB_NAME}\"/slashtec"
        sh "mkdir ~/workspace/\"${JOB_NAME}\"/slashtec  ; cd slashtec ; git clone -b main ${gitUrl} "
        //sh "pwd"
        sh("cp slashtec/momen/slashtec/momen30/Docker/Dockerfile . ")
        sh("cp slashtec/momen/slashtec/momen30/Docker/index.html .")   
        sh("cp slashtec/momen/slashtec/momen30/Docker/info.php .")
        sh("cp slashtec/momen/slashtec/momen30/Docker/nginx.conf .")
        sh("cp slashtec/momen/slashtec/momen30/Docker/supervisord.conf .")
        sh("cp slashtec/momen/slashtec/momen30/Docker/todo_list.php .")        

}

        stage ('ECR Login') {
            sh "aws ecr get-login-password --region ${awsRegion} | docker login --username AWS --password-stdin ${ecrUrl}"
        }  

        stage ('Docker Build') {
            dir('Docker') {
                sh "docker build -t ${ecrUrl}/${serviceName}:${imageTag} ."
            }
        }

        stage ('Docker Push') {
            sh "docker push ${ecrUrl}/${serviceName}:${imageTag}"
        }  

        stage ("change image tag") {
 //         sh " aws eks update-kubeconfig --region us-east-2 --name waseemeks-dev"  
 //            sh """
 //               helm upgrade --install  slashtec Slashtec-Helm-Chart-main/charts/slashtec-helm-chart \
 //               --namespace ${EnvName} \
 //               --set deployment.replicaCount:.image.repository=${ecrUrl}/${serviceName} \
 //               --set deployment.replicaCount.image.tag=${imageTag} \
 //               --create-namespace 
               
                
  //          """

      sh ("cd ${helmDir}; pathEnv=\".deployment.image.tag\" valueEnv=\"${imageTag}-${commitId}\" yq 'eval(strenv(pathEnv)) = strenv(valueEnv)' -i values.yaml ")    
      sh ("cd ${helmDir}; pathEnv=\".appVersion\" valueEnv=\"${imageTag}-${commitId}\" yq 'eval(strenv(pathEnv)) = strenv(valueEnv)' -i Chart.yaml ")
      sh ("cd ${helmDir}; git pull ;git add values.yaml; git add Chart.yaml; git commit -m '${serviceName}_${namespace}_build_${BUILD_NUMBER}' ;git push ${gitUrl}")
   
        }

        stage('Remove Local Images') {
            sh "docker rmi -f ${ecrUrl}/${imageTag} || :"
        }   
    } catch (e) {
        currentBuild.result = "FAILED"
        throw e
    } finally {
        notifyBuild(currentBuild.result)
    }
}

def notifyBuild(String buildStatus = 'STARTED') {
    buildStatus = buildStatus ?: 'SUCCESSFUL'

    def colorCode = '#FF0000'
    def subject = "${buildStatus}: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'"
    def summary = "${subject} (${env.BUILD_URL})"

    if (buildStatus == 'STARTED') {
        colorCode = '#FFFF00'
    } else if (buildStatus == 'SUCCESSFUL') {
        colorCode = '#00FF00'
    }
    // slackSend or other notification methods go here
}
